{{ define "content" }}
<div class="container mt-4">

    <!-- Filter Form -->
    <form method="POST" action="/" id="filterForm">
        <div class="form-row">
            <div class="form-group col-md-3">
                <label for="awsAccountName">AWS Account Name</label>
                <select name="awsAccountName" class="form-control" onchange="submitForm()">
                    <option value="">All Accounts</option>
                    {{range .UniqueAWSAccountNames}}
                    <option value="{{.}}" {{if eq . $.SelectedAWSAccountName}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="service">Service</label>
                <select name="service" class="form-control" onchange="submitForm()">
                    <option value="">All Services</option>
                    {{range .UniqueServices}}
                    <option value="{{.}}" {{if eq . $.SelectedService}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="owner">Owner</label>
                <select name="owner" class="form-control" onchange="submitForm()">
                    <option value="">All Owners</option>
                    {{range .UniqueOwners}}
                    <option value="{{.}}" {{if eq . $.SelectedOwner}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            <div class="form-group col-md-3">
                <label for="region">Region</label>
                <select name="region" class="form-control" onchange="submitForm()">
                    <option value="">All Regions</option>
                    {{range .UniqueRegions}}
                    <option value="{{.}}" {{if eq . $.SelectedRegion}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
        </div>
    </form>

    <!-- Form to Select Instances and Restart -->
    <form method="POST" action="/restart">
        <table class="table table-striped" id="instanceTable">
            <thead>
                <tr>
                    <th>Select</th>
                    <th data-sort="AWSAccountName">AWS Account Name</th>
                    <th data-sort="State">State</th>
                    <th data-sort="UptimeDays">Uptime Days</th>
                    <th data-sort="EC2Name">Name</th>
                    <th data-sort="ID">Instance ID</th>
                    <th data-sort="Service">Service</th>
                    <th data-sort="Owner">Owner</th>
                    <th data-sort="Region">Region</th>
                </tr>
            </thead>
            <tbody>
                {{if .Instances}}
                {{range .Instances}}
                <tr>
                    <td><input type="checkbox" name="instance_ids" value="{{.ID}}"></td>
                    <td>{{.AWSAccountName}}</td>
                    <td>{{.State}}</td>
                    <td>{{.UptimeDays}}</td>
                    <td>{{.EC2Name}}</td>
                    <td>{{.ID}}</td>
                    <td>{{.Service}}</td>
                    <td>{{.Owner}}</td>
                    <td>{{.Region}}</td>
                </tr>
                {{end}}
                {{else}}
                <tr>
                    <td colspan="9" class="text-center">No instances found for the selected criteria.</td>
                </tr>
                {{end}}
            </tbody>
        </table>

        {{ if .IsLoggedIn }}
            <button type="submit" class="btn btn-danger">Restart Selected Instances</button>
        {{ else }}
            <p class="text-center"><em>Log in to restart instances.</em></p>
        {{ end }}
    </form>
</div>

<!-- Optional JavaScript -->
<script>
    // Submit form when a filter dropdown is changed
    function submitForm() {
        document.getElementById('filterForm').submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('instanceTable');
        const headers = table.querySelectorAll('th[data-sort]');
        let sortOrder = 1; // 1 for ascending, -1 for descending

        headers.forEach(header => {
            header.addEventListener('click', function () {
                const fieldIndex = this.cellIndex;
                const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.querySelector('td'));
                
                rows.sort((a, b) => {
                    const aText = a.cells[fieldIndex].textContent.trim();
                    const bText = b.cells[fieldIndex].textContent.trim();

                    if (!isNaN(aText) && !isNaN(bText)) {
                        return sortOrder * (parseFloat(aText) - parseFloat(bText));
                    }
                    return sortOrder * aText.localeCompare(bText);
                });

                // Append sorted rows back to tbody
                const tbody = table.querySelector('tbody');
                rows.forEach(row => tbody.appendChild(row));

                // Toggle sorting order
                sortOrder *= -1;
            });
        });
    });
</script>
{{ end }}
